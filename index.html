import { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInWithCustomToken, 
    onAuthStateChanged, 
    signInAnonymously
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    onSnapshot, 
    collection, 
    query, 
    addDoc, 
    deleteDoc,
    getDocs,
    where,
    runTransaction
} from 'firebase/firestore';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title } from 'chart.js';
import { Doughnut, Bar } from 'react-chartjs-2';
import { format, parseISO } from 'date-fns';

// Register Chart.js components
ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title);

// Placeholder para as variáveis globais
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The main App component
const App = () => {
    // --- Authentication and Project State ---
    const [user, setUser] = useState(null);
    const [userId, setUserId] = useState(null);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentProject, setCurrentProject] = useState(null);
    const [projects, setProjects] = useState([]);

    // --- Data and UI State ---
    const [expenses, setExpenses] = useState([]);
    const [budgetItem, setBudgetItem] = useState('');
    const [budgetAmount, setBudgetAmount] = useState('');
    const [budgets, setBudgets] = useState([]);
    const [expenseDescription, setExpenseDescription] = useState('');
    const [expenseAmount, setExpenseAmount] = useState('');
    const [expenseDate, setExpenseDate] = useState(format(new Date(), 'yyyy-MM-dd'));
    const [selectedFilter, setSelectedFilter] = useState('all');
    const [showInfoModal, setShowInfoModal] = useState(false);
    const [infoModalContent, setInfoModalContent] = useState({ title: '', message: '' });
    const [activeTab, setActiveTab] = useState('dashboard');
    const [searchTerm, setSearchTerm] = useState('');
    const [expenseType, setExpenseType] = useState('Material');

    // --- Refs ---
    const mainContainerRef = useRef(null);

    // --- Firebase Initialization and Authentication ---
    useEffect(() => {
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                setLoading(false);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authInstance = getAuth(app);
                
                setDb(firestore);
                setAuth(authInstance);

                // Listen for authentication state changes
                const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        setUserId(currentUser.uid);
                    } else {
                        // Sign in anonymously if not authenticated
                        await signInAnonymously(authInstance);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                setInfoModalContent({
                    title: "Erro de Inicialização",
                    message: "Não foi possível conectar ao Firebase. Verifique sua conexão e tente novamente."
                });
                setShowInfoModal(true);
                setLoading(false);
            }
        };

        initializeFirebase();
    }, []);

    // --- Real-time data listener ---
    useEffect(() => {
        if (!db || !userId) return;

        // Listener for projects
        const projectsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
        const projectsUnsubscribe = onSnapshot(projectsColRef, (snapshot) => {
            const projectsData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setProjects(projectsData);
            if (!currentProject && projectsData.length > 0) {
                setCurrentProject(projectsData[0]);
            }
        }, (error) => {
            console.error("Error listening to projects:", error);
            setInfoModalContent({
                title: "Erro de Sincronização",
                message: "Não foi possível sincronizar os projetos. Tente recarregar a página."
            });
            setShowInfoModal(true);
        });

        return () => {
            projectsUnsubscribe();
        };
    }, [db, userId, currentProject]);

    // Listener for expenses and budgets
    useEffect(() => {
        if (!db || !userId || !currentProject) return;

        const expensesColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/expenses`);
        const expensesUnsubscribe = onSnapshot(expensesColRef, (snapshot) => {
            const expensesData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setExpenses(expensesData);
        }, (error) => {
            console.error("Error listening to expenses:", error);
        });

        const budgetsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/budgets`);
        const budgetsUnsubscribe = onSnapshot(budgetsColRef, (snapshot) => {
            const budgetsData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setBudgets(budgetsData);
        }, (error) => {
            console.error("Error listening to budgets:", error);
        });

        return () => {
            expensesUnsubscribe();
            budgetsUnsubscribe();
        };
    }, [db, userId, currentProject]);

    // --- Helper Functions ---
    const showMessageModal = (title, message) => {
        setInfoModalContent({ title, message });
        setShowInfoModal(true);
    };

    // --- CRUD Operations ---
    const addProject = async () => {
        if (!db || !userId) {
            showMessageModal("Erro", "Não foi possível adicionar o projeto. Tente novamente.");
            return;
        }

        const newProjectName = prompt("Digite o nome do novo projeto:");
        if (!newProjectName) return;

        const projectsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
        const docRef = doc(projectsColRef);

        try {
            await setDoc(docRef, { name: newProjectName, createdAt: new Date() });
            showMessageModal("Sucesso", `Projeto "${newProjectName}" criado com sucesso!`);
            setCurrentProject({ id: docRef.id, name: newProjectName });
        } catch (e) {
            console.error("Error adding project: ", e);
            showMessageModal("Erro", "Não foi possível criar o projeto. Verifique a sua conexão.");
        }
    };

    const deleteProject = async (projectId) => {
        if (!db || !userId || !projectId) {
            showMessageModal("Erro", "Não foi possível remover o projeto. Tente novamente.");
            return;
        }

        if (!window.confirm("Tem certeza que deseja remover este projeto e todos os seus dados?")) {
            return;
        }

        try {
            // Delete expenses subcollection
            const expensesColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${projectId}/expenses`);
            const expenseDocs = await getDocs(expensesColRef);
            await Promise.all(expenseDocs.docs.map(doc => deleteDoc(doc.ref)));

            // Delete budgets subcollection
            const budgetsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${projectId}/budgets`);
            const budgetDocs = await getDocs(budgetsColRef);
            await Promise.all(budgetDocs.docs.map(doc => deleteDoc(doc.ref)));

            // Delete the project document itself
            const projectDocRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${projectId}`);
            await deleteDoc(projectDocRef);

            // After deletion, switch to the first project in the list or null if none exist
            setProjects(prevProjects => {
                const updatedProjects = prevProjects.filter(p => p.id !== projectId);
                if (updatedProjects.length > 0) {
                    setCurrentProject(updatedProjects[0]);
                } else {
                    setCurrentProject(null);
                }
                return updatedProjects;
            });

            showMessageModal("Sucesso", "Projeto removido com sucesso!");
        } catch (e) {
            console.error("Error removing project: ", e);
            showMessageModal("Erro", "Não foi possível remover o projeto. Verifique a sua conexão.");
        }
    };

    const addBudgetItem = async () => {
        if (!budgetItem || !budgetAmount || !currentProject) {
            showMessageModal("Erro", "Preencha todos os campos do orçamento.");
            return;
        }
        if (isNaN(parseFloat(budgetAmount))) {
            showMessageModal("Erro", "O valor do orçamento deve ser um número.");
            return;
        }

        const budgetsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/budgets`);

        try {
            await addDoc(budgetsColRef, {
                item: budgetItem,
                amount: parseFloat(budgetAmount),
                createdAt: new Date()
            });
            setBudgetItem('');
            setBudgetAmount('');
            showMessageModal("Sucesso", "Item de orçamento adicionado.");
        } catch (e) {
            console.error("Error adding budget item: ", e);
            showMessageModal("Erro", "Não foi possível adicionar o item de orçamento. Tente novamente.");
        }
    };

    const deleteBudgetItem = async (id) => {
        if (!id || !currentProject) return;

        const docRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/budgets`, id);
        try {
            await deleteDoc(docRef);
            showMessageModal("Sucesso", "Item de orçamento removido.");
        } catch (e) {
            console.error("Error removing budget item: ", e);
            showMessageModal("Erro", "Não foi possível remover o item de orçamento. Tente novamente.");
        }
    };

    const addExpense = async () => {
        if (!expenseDescription || !expenseAmount || !expenseDate || !expenseType || !currentProject) {
            showMessageModal("Erro", "Preencha todos os campos da despesa.");
            return;
        }
        if (isNaN(parseFloat(expenseAmount))) {
            showMessageModal("Erro", "O valor da despesa deve ser um número.");
            return;
        }

        const expensesColRef = collection(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/expenses`);

        try {
            await addDoc(expensesColRef, {
                description: expenseDescription,
                amount: parseFloat(expenseAmount),
                date: expenseDate,
                type: expenseType,
                createdAt: new Date()
            });
            setExpenseDescription('');
            setExpenseAmount('');
            setExpenseType('Material');
            setExpenseDate(format(new Date(), 'yyyy-MM-dd'));
            showMessageModal("Sucesso", "Despesa adicionada.");
        } catch (e) {
            console.error("Error adding expense: ", e);
            showMessageModal("Erro", "Não foi possível adicionar a despesa. Tente novamente.");
        }
    };

    const deleteExpense = async (id) => {
        if (!id || !currentProject) return;

        const docRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${currentProject.id}/expenses`, id);
        try {
            await deleteDoc(docRef);
            showMessageModal("Sucesso", "Despesa removida.");
        } catch (e) {
            console.error("Error removing expense: ", e);
            showMessageModal("Erro", "Não foi possível remover a despesa. Tente novamente.");
        }
    };
    
    // --- Data Processing for Charts and Display ---
    const filterAndSearchExpenses = () => {
        let filtered = expenses.filter(expense => {
            const matchesFilter = selectedFilter === 'all' || expense.type === selectedFilter;
            const matchesSearch = searchTerm === '' || expense.description.toLowerCase().includes(searchTerm.toLowerCase());
            return matchesFilter && matchesSearch;
        });

        // Sort by date in descending order
        return filtered.sort((a, b) => parseISO(b.date).getTime() - parseISO(a.date).getTime());
    };

    const totalBudget = budgets.reduce((sum, item) => sum + item.amount, 0);
    const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
    const remainingBudget = totalBudget - totalExpenses;

    const getDoughnutData = () => {
        const materialExpenses = expenses
            .filter(e => e.type === 'Material')
            .reduce((sum, e) => sum + e.amount, 0);
        const laborExpenses = expenses
            .filter(e => e.type === 'Mão de Obra')
            .reduce((sum, e) => sum + e.amount, 0);
        const otherExpenses = expenses
            .filter(e => e.type === 'Outros')
            .reduce((sum, e) => sum + e.amount, 0);

        return {
            labels: ['Materiais', 'Mão de Obra', 'Outros'],
            datasets: [
                {
                    data: [materialExpenses, laborExpenses, otherExpenses],
                    backgroundColor: ['#3B82F6', '#22C55E', '#F97316'],
                    borderColor: ['#ffffff'],
                    borderWidth: 2,
                },
            ],
        };
    };

    const getBudgetAllocationData = () => {
        const labels = budgets.map(b => b.item);
        const amounts = budgets.map(b => b.amount);
        return {
            labels: labels,
            datasets: [
                {
                    label: 'Alocação do Orçamento',
                    data: amounts,
                    backgroundColor: '#10B981',
                    borderColor: '#059669',
                    borderWidth: 1,
                },
            ],
        };
    };

    const getMonthlyExpensesData = () => {
        const monthlyData = expenses.reduce((acc, expense) => {
            const month = format(parseISO(expense.date), 'MM/yyyy');
            acc[month] = (acc[month] || 0) + expense.amount;
            return acc;
        }, {});

        const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
            const [monthA, yearA] = a.split('/').map(Number);
            const [monthB, yearB] = b.split('/').map(Number);
            if (yearA !== yearB) return yearA - yearB;
            return monthA - monthB;
        });

        return {
            labels: sortedMonths,
            datasets: [
                {
                    label: 'Despesas por Mês',
                    data: sortedMonths.map(month => monthlyData[month]),
                    backgroundColor: '#EF4444',
                    borderColor: '#B91C1C',
                    borderWidth: 1,
                },
            ],
        };
    };

    // --- Components ---
    const InfoModal = ({ title, message, onClose }) => {
        return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
                <div className="relative p-6 bg-white rounded-lg shadow-xl max-w-sm mx-auto text-center transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
                    <h3 className="text-xl leading-6 font-bold text-gray-900 mb-4">{title}</h3>
                    <div className="mt-2">
                        <p className="text-sm text-gray-500 break-all">{message}</p>
                    </div>
                    <div className="mt-5 sm:mt-6">
                        <button
                            onClick={onClose}
                            type="button"
                            className="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm"
                        >
                            OK
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- Main Render Logic ---
    const renderContent = () => {
        if (loading) {
            return (
                <div className="flex items-center justify-center h-screen bg-gray-100">
                    <div className="flex flex-col items-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                        <p className="text-gray-600 font-medium">Carregando...</p>
                    </div>
                </div>
            );
        }

        if (!user || !userId) {
            return (
                <div className="flex items-center justify-center h-screen bg-gray-100">
                    <div className="text-center p-8 bg-white rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-4">Acesso Negado</h2>
                        <p className="text-gray-600">
                            Não foi possível autenticar o usuário. Por favor, tente novamente mais tarde.
                        </p>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4 sm:p-8">
                <div className="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
                    
                    {/* Header with Project Selection and Add Button */}
                    <header className="bg-white p-4 sm:p-6 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                        <div className="flex items-center space-x-2 w-full sm:w-auto">
                            <h1 className="text-xl sm:text-2xl font-bold text-gray-800 flex-shrink-0">
                                Gestão de Obra
                            </h1>
                            {projects.length > 0 && (
                                <div className="flex-grow sm:flex-grow-0">
                                    <select
                                        value={currentProject ? currentProject.id : ''}
                                        onChange={(e) => {
                                            const selectedProject = projects.find(p => p.id === e.target.value);
                                            setCurrentProject(selectedProject);
                                        }}
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                                    >
                                        {projects.map(project => (
                                            <option key={project.id} value={project.id}>{project.name}</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                        </div>
                        <div className="flex items-center space-x-2">
                            {currentProject && (
                                <button
                                    onClick={() => deleteProject(currentProject.id)}
                                    className="bg-red-500 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-red-600 transition-colors"
                                >
                                    Excluir Projeto
                                </button>
                            )}
                            <button
                                onClick={addProject}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition-colors"
                            >
                                Adicionar Novo Projeto
                            </button>
                        </div>
                    </header>

                    {/* Check if there is a project to display content */}
                    {!currentProject ? (
                        <div className="flex-grow flex items-center justify-center p-8">
                            <p className="text-gray-500 text-lg">
                                Crie um novo projeto para começar a gerenciar suas despesas e orçamentos.
                            </p>
                        </div>
                    ) : (
                        <div className="flex flex-col flex-grow">
                            {/* Tab Navigation */}
                            <nav className="bg-gray-50 border-b border-gray-200">
                                <div className="flex justify-center sm:justify-start -mb-px">
                                    <button
                                        onClick={() => setActiveTab('dashboard')}
                                        className={`py-4 px-6 font-medium text-sm sm:text-base border-b-2 transition-colors duration-300 ${activeTab === 'dashboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
                                    >
                                        Painel de Controle
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('budget')}
                                        className={`py-4 px-6 font-medium text-sm sm:text-base border-b-2 transition-colors duration-300 ${activeTab === 'budget' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
                                    >
                                        Orçamento
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('expenses')}
                                        className={`py-4 px-6 font-medium text-sm sm:text-base border-b-2 transition-colors duration-300 ${activeTab === 'expenses' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
                                    >
                                        Despesas
                                    </button>
                                </div>
                            </nav>
        
                            {/* Main Content based on active tab */}
                            <div className="p-4 sm:p-8 flex-grow overflow-y-auto">
                                {activeTab === 'dashboard' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                            <h2 className="text-lg sm:text-xl font-semibold mb-2 text-gray-800">Resumo Financeiro</h2>
                                            <p className="text-sm sm:text-base text-gray-600">Orçamento Total: <span className="font-bold text-green-600">R$ {totalBudget.toFixed(2)}</span></p>
                                            <p className="text-sm sm:text-base text-gray-600">Total de Despesas: <span className="font-bold text-red-600">R$ {totalExpenses.toFixed(2)}</span></p>
                                            <p className="text-sm sm:text-base text-gray-600">
                                                Orçamento Restante: 
                                                <span className={`font-bold ${remainingBudget >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    R$ {remainingBudget.toFixed(2)}
                                                </span>
                                            </p>
                                        </div>
        
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex items-center justify-center">
                                            <div className="w-full max-w-xs">
                                                <h2 className="text-lg sm:text-xl font-semibold text-center mb-4 text-gray-800">Despesas por Categoria</h2>
                                                {expenses.length > 0 ? (
                                                    <Doughnut data={getDoughnutData()} />
                                                ) : (
                                                    <p className="text-center text-sm text-gray-500">Nenhuma despesa para exibir.</p>
                                                )}
                                            </div>
                                        </div>
        
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex items-center justify-center">
                                            <div className="w-full">
                                                <h2 className="text-lg sm:text-xl font-semibold text-center mb-4 text-gray-800">Orçamento por Item</h2>
                                                {budgets.length > 0 ? (
                                                    <Bar 
                                                        data={getBudgetAllocationData()}
                                                        options={{ responsive: true, maintainAspectRatio: true }}
                                                    />
                                                ) : (
                                                    <p className="text-center text-sm text-gray-500">Nenhum item de orçamento para exibir.</p>
                                                )}
                                            </div>
                                        </div>
        
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 col-span-1 md:col-span-2 lg:col-span-3">
                                            <h2 className="text-lg sm:text-xl font-semibold text-center mb-4 text-gray-800">Despesas ao Longo do Tempo</h2>
                                            {expenses.length > 0 ? (
                                                <Bar
                                                    data={getMonthlyExpensesData()}
                                                    options={{ responsive: true, maintainAspectRatio: true }}
                                                />
                                            ) : (
                                                <p className="text-center text-sm text-gray-500">Nenhuma despesa para exibir.</p>
                                            )}
                                        </div>
                                    </div>
                                )}
        
                                {activeTab === 'budget' && (
                                    <div className="space-y-8">
                                        <div className="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
                                            <h2 className="text-lg sm:text-xl font-bold mb-4 text-gray-800">Adicionar Item ao Orçamento</h2>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <input
                                                    type="text"
                                                    value={budgetItem}
                                                    onChange={(e) => setBudgetItem(e.target.value)}
                                                    placeholder="Item (Ex: Telhado)"
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                <input
                                                    type="number"
                                                    value={budgetAmount}
                                                    onChange={(e) => setBudgetAmount(e.target.value)}
                                                    placeholder="Valor (R$)"
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                <button onClick={addBudgetItem} className="w-full bg-green-500 text-white font-medium py-2 rounded-lg shadow-md hover:bg-green-600 transition-colors">
                                                    Adicionar
                                                </button>
                                            </div>
                                        </div>
        
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                            <h2 className="text-lg sm:text-xl font-bold mb-4 text-gray-800">Itens do Orçamento</h2>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Item
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Valor (R$)
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Ações
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {budgets.length > 0 ? (
                                                            budgets.map(budget => (
                                                                <tr key={budget.id}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{budget.item}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{budget.amount.toFixed(2)}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                        <button onClick={() => deleteBudgetItem(budget.id)} className="text-red-600 hover:text-red-900 transition-colors">Remover</button>
                                                                    </td>
                                                                </tr>
                                                            ))
                                                        ) : (
                                                            <tr>
                                                                <td colSpan="3" className="px-6 py-4 text-center text-sm text-gray-500">Nenhum item de orçamento registrado ainda.</td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}
        
                                {activeTab === 'expenses' && (
                                    <div className="space-y-8">
                                        <div className="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
                                            <h2 className="text-lg sm:text-xl font-bold mb-4 text-gray-800">Adicionar Nova Despesa</h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                <select
                                                    value={expenseType}
                                                    onChange={(e) => setExpenseType(e.target.value)}
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                >
                                                    <option value="Material">Material</option>
                                                    <option value="Mão de Obra">Mão de Obra</option>
                                                    <option value="Outros">Outros</option>
                                                </select>
                                                <input
                                                    type="text"
                                                    value={expenseDescription}
                                                    onChange={(e) => setExpenseDescription(e.target.value)}
                                                    placeholder="Descrição (Ex: Cimento)"
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                <input
                                                    type="number"
                                                    value={expenseAmount}
                                                    onChange={(e) => setExpenseAmount(e.target.value)}
                                                    placeholder="Valor (R$)"
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                                <input
                                                    type="date"
                                                    value={expenseDate}
                                                    onChange={(e) => setExpenseDate(e.target.value)}
                                                    className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                />
                                            </div>
                                            <button onClick={addExpense} className="mt-4 w-full bg-blue-600 text-white font-medium py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                                                Registrar Despesa
                                            </button>
                                        </div>
        
                                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                            <h2 className="text-lg sm:text-xl font-bold mb-4 text-gray-800">Registro de Despesas</h2>
                                            <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                                                <div className="flex-grow">
                                                    <input
                                                        type="text"
                                                        value={searchTerm}
                                                        onChange={(e) => setSearchTerm(e.target.value)}
                                                        placeholder="Buscar por descrição..."
                                                        className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                    />
                                                </div>
                                                <select
                                                    value={selectedFilter}
                                                    onChange={(e) => setSelectedFilter(e.target.value)}
                                                    className="w-full sm:w-auto px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                                                >
                                                    <option value="all">Todas as Despesas</option>
                                                    <option value="Material">Material</option>
                                                    <option value="Mão de Obra">Mão de Obra</option>
                                                    <option value="Outros">Outros</option>
                                                </select>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Data
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Descrição
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Tipo
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Valor (R$)
                                                            </th>
                                                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                                Ações
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {filterAndSearchExpenses().length > 0 ? (
                                                            filterAndSearchExpenses().map(expense => (
                                                                <tr key={expense.id}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{format(parseISO(expense.date), 'dd/MM/yyyy')}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{expense.description}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.type}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.amount.toFixed(2)}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                        <button onClick={() => deleteExpense(expense.id)} className="text-red-600 hover:text-red-900 transition-colors">Remover</button>
                                                                    </td>
                                                                </tr>
                                                            ))
                                                        ) : (
                                                            <tr>
                                                                <td colSpan="5" className="px-6 py-4 text-center text-sm text-gray-500">
                                                                    {expenses.length === 0 ? 'Nenhuma despesa registrada ainda.' : 'Nenhum resultado encontrado.'}
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <footer className="mt-auto pt-4 pb-2 border-t border-gray-200 text-center bg-gray-50">
                        <p className="text-gray-500 text-xs">
                            ID do Usuário: <span className="font-mono break-all">{userId}</span>
                        </p>
                    </footer>
                </div>
            </div>
        );
    };

    return (
        <>
            {renderContent()}
            {showInfoModal && (
                <InfoModal
                    title={infoModalContent.title}
                    message={infoModalContent.message}
                    onClose={() => setShowInfoModal(false)}
                />
            )}
        </>
    );
};

export default App;
